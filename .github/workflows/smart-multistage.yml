name: 05 Smart Multistage

on:
  push:
    branches:
      - '**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # (Optional but useful for debugging paths)
      - name: List files
        run: |
          pwd
          ls
          ls API
          ls Test

      - name: Restore
        run: dotnet restore Exercise5WorkFlow.sln

      - name: Build
        run: dotnet build Exercise5WorkFlow.sln --configuration Release --no-restore

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore Exercise5WorkFlow.sln

      - name: Run tests
        run: dotnet test Test/Test.csproj --configuration Release --no-restore --verbosity normal

# üëá New job: sends Discord notification after tests
  notify-discord:
    runs-on: ubuntu-latest
    needs: test
    if: ${{ always() }}   # run even if test job fails
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
    steps:
      - name: Notify Discord ‚Äì Tests Succeeded
        if: ${{ needs.test.result == 'success' }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg content "‚úÖ Tests PASSED for \($GITHUB_REPOSITORY) on branch \($GITHUB_REF_NAME). Run: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" '{content: $content}')"

      - name: Notify Discord ‚Äì Tests Failed
        if: ${{ needs.test.result != 'success' }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg content "‚ùå Tests FAILED for \($GITHUB_REPOSITORY) on branch \($GITHUB_REF_NAME). Run: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" '{content: $content}')"

  deploy-dev:
    runs-on: ubuntu-latest
    needs: test
    environment: development

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore Exercise5WorkFlow.sln

      - name: Publish for DEV
        run: dotnet publish API/API.csproj -c Release -o ./out-dev

      - name: Show service name from repo vars
        run: echo "Deploying service ${{ vars.SERVICE_NAME }} to DEV environment"

      - name: Simulate DEV deployment
        run: |
          echo "Simulating deployment to DEV using files in ./out-dev"
          ls ./out-dev

  deploy-prod:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/master'
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore Exercise5WorkFlow.sln

      - name: Publish for PROD
        run: dotnet publish API/API.csproj -c Release -o ./out-prod

      - name: Mask and use PROD API key
        run: |
          echo "::add-mask::${{ secrets.PROD_API_KEY }}"
          echo "Using PROD API KEY: ${{ secrets.PROD_API_KEY }}"
          echo "Service: ${{ vars.SERVICE_NAME }} deploying to PROD..."

      - name: Simulate PROD deployment
        run: |
          echo "Simulating deployment to PROD using files in ./out-prod"
          ls ./out-prod
          echo "‚úÖ Deployment completed successfully"
