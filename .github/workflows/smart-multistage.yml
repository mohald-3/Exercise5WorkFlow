name: 05 Smart Multistage

on:
  push:
    branches:
      - '**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # (Optional but useful for debugging paths)
      - name: List files
        run: |
          pwd
          ls
          ls API
          ls Test

      - name: Restore
        run: dotnet restore Exercise5WorkFlow.sln

      - name: Build
        run: dotnet build Exercise5WorkFlow.sln --configuration Release --no-restore

  test:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore Exercise5WorkFlow.sln

      - name: Run tests
        run: dotnet test Test/Test.csproj --configuration Release --no-restore --verbosity normal

  deploy-dev:
    runs-on: ubuntu-latest
    needs: test
    environment: development

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore Exercise5WorkFlow.sln

      - name: Publish for DEV
        run: dotnet publish API/API.csproj -c Release -o ./out-dev

      - name: Show service name from repo vars
        run: echo "Deploying service ${{ vars.SERVICE_NAME }} to DEV environment"

      - name: Simulate DEV deployment
        run: |
          echo "Simulating deployment to DEV using files in ./out-dev"
          ls ./out-dev

  deploy-prod:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    environment: prod

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore Exercise5WorkFlow.sln

      - name: Publish for PROD
        run: dotnet publish API/API.csproj -c Release -o ./out-prod

      - name: Mask and use PROD API key
        run: |
          echo "::add-mask::${{ secrets.PROD_API_KEY }}"
          echo "Using PROD API KEY: ${{ secrets.PROD_API_KEY }}"
          echo "Service: ${{ vars.SERVICE_NAME }} deploying to PROD..."

      - name: Simulate PROD deployment
        run: |
          echo "Simulating deployment to PROD using files in ./out-prod"
          ls ./out-prod
          echo "âœ… Deployment completed successfully"
